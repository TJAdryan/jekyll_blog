# ... (previous stages like BuildBlog are unchanged) ...

- stage: DeployToGitHubPages
  displayName: 'Deploy to GitHub Pages'
  dependsOn: BuildBlog
  condition: succeeded() # Only deploy if the build was successful

  jobs:
  - job: DeployJob
    displayName: 'Push to GitHub Pages'
    steps:
    - download: current
      artifact: '$(artifactName)'
      displayName: 'Download Built Site Artifact'

    # This script handles the Git operations to push to GitHub Pages.
    # We are using 'script:' and explicitly stating '#!/bin/bash' to ensure it runs as Bash.
    - script: |  # Changed from - task: Bash@3
        #!/bin/bash # Explicitly tell the system to use the Bash interpreter
        set -e # Exit immediately if a command exits with a non-zero status.

        # Set Git user for the commit
        git config --global user.email "azure-devops@$(Build.Repository.Name).com"
        git config --global user.name "Azure DevOps CD Pipeline"

        # Clone the GitHub repository into a temporary directory
        # Use the GITHUB_PAT for authentication. Replace 'TJAdryan' with your actual GitHub username/organization.
        git clone https://x-access-token:$(GITHUB_PAT)@github.com/TJAdryan/$(Build.Repository.Name).git temp_repo

        # Navigate into the cloned repository
        cd temp_repo

        # Checkout the GitHub Pages branch. Create it if it doesn't exist.
        git checkout $(githubPagesBranch) || git checkout -b $(githubPagesBranch)

        # Remove all existing files (except .git folder) to ensure a clean deploy.
        # This is crucial for static sites to remove old files that are no longer generated.
        # This is a more robust way to delete all files/folders except the .git directory.
        find . -maxdepth 1 -mindepth 1 ! -name '.git' -exec rm -rf {} +

        # Copy the newly built site files from the artifact download directory
        # The artifact will be downloaded to $(Pipeline.Workspace)/$(artifactName)
        cp -r "$(Pipeline.Workspace)/$(artifactName)/." .

        # Add all changes, commit, and push to the GitHub Pages branch
        git add .
        git commit -m "Azure DevOps CD: Deployed new blog content - $(Build.BuildId) [skip ci]" # [skip ci] prevents infinite loops
        git push origin $(githubPagesBranch)
      displayName: 'Push to GitHub Pages' # This displayName is fine
      env:
        # Make sure GITHUB_PAT is defined as a secret variable in a variable group
        # and that the variable group is linked to this pipeline.
        GITHUB_PAT: $(GITHUB_PAT)